name: Build XanMod Cloud Kernel 6.12

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      DEB_BUILD_OPTIONS: nocheck
      KERNEL_LOCALVERSION: -cloud

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Maximize build disk space
        uses: easimon/maximize-build-space@master
        with:
          remove-dotnet: true
          remove-android: true
          remove-haskell: true
          remove-codeql: true
          remove-docker-images: true

      - name: Show system & set-timezone
        run: |
          echo -e "Total CPU cores\t: $(nproc)"
          cat /proc/cpuinfo
          cat /proc/meminfo
          sudo timedatectl set-timezone Asia/Shanghai

      - name: Cache LLVM
        uses: actions/cache@v5
        with:
          path: /usr/lib/llvm-21
          key: llvm-21-${{ runner.os }}

      - name: Install LLVM/Clang
        run: |
          sudo apt-get update
          sudo apt-get install -y wget lsb-release gnupg
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 21 all
          echo "PATH=/usr/lib/llvm-21/bin:$PATH" >> $GITHUB_ENV

      - name: Install dependencies
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-mark hold grub-efi-amd64-signed firefox snapd mysql* || true
          sudo apt-get autoremove -y --purge
          sudo apt-get clean
          sudo -E apt-get -y update
          sudo apt-get update
          sudo apt-get install -y \
            build-essential bc bison flex \
            libssl-dev libelf-dev libncurses-dev \
            libdw-dev debhelper debhelper-compat dpkg-dev devscripts \
            linux-libc-dev linux-firmware curl wget \
            dwarves pahole fakeroot git pkg-config perl \
            rsync xz-utils zstd binutils cpio initramfs-tools
          sudo -E systemctl daemon-reload || true
          sudo apt-get autoremove -y --purge
          sudo apt-get clean

      - name: Clone XanMod kernel
        run: |
          git clone --depth=1 --branch 6.12 https://gitlab.com/xanmod/linux.git kernel

      - name: Cache kernel build
        uses: actions/cache@v5
        with:
          path: |
            kernel/.cache
            kernel/arch/x86
            kernel/drivers
          key: kernel-6.12-xanmod-${{ github.ref }}

      - name: Apply cloud config for KVM VPS
        run:  |
          cd kernel
          cp CONFIGS/xanmod/gcc/config_x86-64-v3 .config
          scripts/config --disable CONFIG_USELIB
          scripts/config --disable CONFIG_AUDIT
          scripts/config --disable CONFIG_AUDITSYSCALL
          scripts/config --disable CONFIG_NO_HZ_FULL
          scripts/config --enable CONFIG_NO_HZ_IDLE
          scripts/config --disable CONFIG_CONTEXT_TRACKING_USER
          scripts/config --disable CONFIG_BPF_LSM
          scripts/config --disable CONFIG_PREEMPT_DYNAMIC
          scripts/config --enable CONFIG_PREEMPT_VOLUNTARY
          scripts/config --disable CONFIG_SCHED_CORE
          # 关闭老式和现代 task 记账
          scripts/config --disable CONFIG_BSD_PROCESS_ACCT
          scripts/config --disable CONFIG_BSD_PROCESS_ACCT_V3
          scripts/config --disable CONFIG_TASKSTATS
          scripts/config --disable CONFIG_TASK_DELAY_ACCT
          scripts/config --disable CONFIG_TASK_XACCT
          scripts/config --disable CONFIG_TASK_IO_ACCOUNTING
          scripts/config --disable CONFIG_PSI
          scripts/config --disable CONFIG_CPU_ISOLATION
          scripts/config --disable CONFIG_TASKS_RUDE_RCU
          scripts/config --disable CONFIG_TASKS_TRACE_RCU
          scripts/config --disable CONFIG_RCU_NOCB_CPU
          scripts/config --disable CONFIG_IKHEADERS
          scripts/config --set-val CONFIG_LOG_BUF_SHIFT 17
          scripts/config --disable CONFIG_NUMA_BALANCING
          scripts/config --disable CONFIG_NUMA_BALANCING_DEFAULT_ENABLED
# 保留基础 cgroup 支持
          scripts/config --enable CONFIG_CGROUPS
          scripts/config --enable CONFIG_MEMCG
          scripts/config --enable CONFIG_CGROUP_PIDS
          scripts/config --enable CONFIG_CGROUP_FREEZER
          scripts/config --enable CONFIG_CGROUP_DEVICE


          #scripts/config --enable CONFIG_GENERIC_CPU
          #scripts/config --set-val CONFIG_X86_64_VERSION 3






          # 自己想做的调整想要的精简放这里

          make LLVM=1 LLVM_IAS=1 CC=clang LD=ld.lld olddefconfig

      - name: Export final kernel .config
        run: |
          mkdir -p artifacts
          cp kernel/.config artifacts/config-6.12-clang-${{ github.run_id }}

      - name: Build kernel vmlinux
        run: |
          cd kernel
          make -j$(nproc) LLVM=1 LLVM_IAS=1 CC=clang LD=ld.lld vmlinux modules_prepare KCFLAGS="-march=x86-64-v3 -O3 -Wno-error"

      - name: Build kernel modules_prepare
        run: |
          cd kernel
          make -j$(nproc) LLVM=1 LLVM_IAS=1 CC=clang LD=ld.lld modules_prepare KCFLAGS="-march=x86-64-v3 -O3 -Wno-error"

      - name: Build kernel deb packages
        run: |
          cd kernel
          KDEB_COMPRESS=xz make -j$(nproc) LLVM=1 LLVM_IAS=1 CC=clang LD=ld.lld bindeb-pkg LOCALVERSION=${KERNEL_LOCALVERSION} KCFLAGS="-march=x86-64-v3 -O3 -Wno-error"

      - name: Collect kernel artifacts
        run: |
          mkdir -p artifacts
          mv linux-image-*.deb artifacts/
          mv linux-headers-*.deb artifacts/

      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: xanmod-cloud-${{ github.run_id }}
          name: XanMod Cloud Kernel
          files: artifacts/*
